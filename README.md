# DAoSS
Проектирование и архитектура программных систем

Backend — .NET 8, 3-tier архитектура
====================================

## Структура каталогов

```
DAOSS gh/
└─ src/
   ├─ Domain/                 // Доменная модель (сущности)
   │  └─ Entities/            // BaseEntity, User, Project, Diagram, Review, ...
   ├─ Application/            // Контракты (интерфейсы сервисов), DTO
   │  ├─ Interfaces/          // IAuthService, IReviewService, IInvitationService, ...
   │  └─ Repositories/         // Интерфейсы репозиториев
   ├─ Infrastructure/         // Доступ к данным, EF Core, реализация сервисов
   │  ├─ Persistence/         // AppDbContext
   │  ├─ Repositories/        // Реализации репозиториев
   │  └─ Services/            // Реализации сервисов (AuthService, ReviewService, ...)
   └─ WebApi/                 // Веб-API (контроллеры, Program.cs)
      └─ Controllers/         // AuthController, ProjectsController, ReviewsController, ...
```

## Сборка и запуск

Из корня `DAOSS gh`:

```bash
dotnet build DAOSS.sln
dotnet run --project src/WebApi/DAOSS.WebApi.csproj
```

## Архитектура слоёв

- **Domain** — не зависит от других слоёв. Содержит сущности предметной области.
- **Application** — зависит от Domain. Определяет интерфейсы сервисов и репозиториев.
- **Infrastructure** — зависит от Domain и Application. Реализует доступ к данным и бизнес-логику.
- **WebApi** — зависит от Application и Infrastructure. Предоставляет HTTP API.

## Функционал бэкенда

### Аутентификация и авторизация

- **Регистрация и вход** (`/api/auth/register`, `/api/auth/login`)
  - Регистрация пользователей с email/login и паролем
  - Аутентификация через JWT токены
  - Хеширование паролей с использованием BCrypt
  - Получение информации о текущем пользователе (`/api/auth/me`)

- **Авторизация на основе ролей**
  - Политики доступа: `ProjectRead`, `ProjectWrite`, `ProjectAdmin`
  - Роли в проектах: `owner`, `admin`, `reviewer`
  - Проверка прав доступа через `ProjectRoleHandler`

### Управление проектами

- **CRUD операции** (`/api/projects`)
  - Создание, чтение, обновление и удаление проектов
  - Поддержка видимости проектов (private/public)
  - Настройка правил ревью через `RequiredReviewersRules` (JSON)
  - Автоматическое добавление владельца в участники при создании

### Управление участниками проекта

- **Управление участниками** (`/api/projects/{projectId}/members`)
  - Добавление участников с назначением роли (owner/admin/reviewer)
  - Получение списка всех участников проекта
  - Изменение роли участника
  - Передача владения проектом (owner может передать права другому участнику)
  - Исключение участников из проекта
  - Защита от удаления владельца проекта

- **Система ролей**
  - **Owner** — полный контроль над проектом, может передавать владение
  - **Admin** — управление участниками и настройками проекта
  - **Reviewer** — просмотр и создание ревью

### Система приглашений

- **Приглашения в проекты** (`/api/projects/{projectId}/invitations`)
  - Отправка приглашений пользователям (только admin/owner)
  - Просмотр приглашений проекта и пользователя
  - Принятие/отклонение приглашений
  - Автоматическое добавление в участники при принятии
  - Отмена приглашений
  - Срок действия приглашений (7 дней)

### Система ревью

- **Управление ревью** (`/api/projects/{projectId}/reviews`)
  - Создание ревью для версий диаграмм или исходных файлов
  - Просмотр списка ревью проекта
  - Изменение статуса ревью (open, approved, changes_requested)
  - Удаление ревью
  - Поддержка типов целей: `diagram_version`, `source_file_version`

- **Элементы ревью** (`/api/projects/{projectId}/reviews/{reviewId}/items`)
  - Создание элементов ревью (comment/issue)
  - Привязка к коду или диаграмме через anchor
  - Управление статусом элементов (open/resolved)
  - Обновление и удаление элементов

- **Комментарии** (`/api/projects/{projectId}/reviews/{reviewId}/items/{itemId}/comments`)
  - Добавление комментариев к элементам ревью
  - Просмотр всех комментариев элемента
  - Редактирование и удаление комментариев
  - Отслеживание автора комментария

### Технические детали

- **База данных**: PostgreSQL через Entity Framework Core
- **Миграции**: Поддержка версионирования схемы БД
- **Unit of Work**: Атомарное сохранение изменений
- **Swagger**: Автоматическая документация API (в режиме Development)
- **Валидация**: Проверка входных данных через Data Annotations
- **Обработка ошибок**: Стандартизированные ответы с сообщениями об ошибках

## Примечания

- Основные сервисы и репозитории реализованы и зарегистрированы в DI контейнере
- Интерфейсы `IParserService`, `IDiagramService`, `ISyncService` определены, но реализации ожидаются в будущем
- Все эндпоинты защищены авторизацией и проверкой прав доступа